<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guild Zone | Player Arena</title>
    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --bg: #0a0a0c; --card: #151518; --blue: #00d2ff; --red: #ff003c; --dim: #a0a0a0; --white: #fff; --neon: 0 0 15px rgba(0, 210, 255, 0.2); }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Rajdhani', sans-serif; }
        body { background: var(--bg); color: var(--white); overflow-x: hidden; }
        h1, h2, h3 { font-family: 'Orbitron'; text-transform: uppercase; }

        /* Auth Screen */
        #auth-overlay { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .auth-box { background: var(--card); width: 92%; max-width: 400px; padding: 30px; border-radius: 12px; border: 1px solid #222; }
        .auth-tabs { display: flex; margin-bottom: 20px; gap: 10px; }
        .auth-tabs button { flex: 1; padding: 12px; background: transparent; border: 1px solid #333; color: #fff; cursor: pointer; border-radius: 4px; }
        .auth-tabs button.active { border-color: var(--blue); color: var(--blue); box-shadow: inset 0 0 5px var(--blue); }

        /* Sidebar & Layout */
        #app-shell { display: none; min-height: 100vh; }
        .sidebar { width: 260px; height: 100vh; background: var(--card); position: fixed; border-right: 1px solid #222; padding: 20px; z-index: 100; transition: 0.3s; }
        .nav-link { display: flex; align-items: center; gap: 15px; padding: 15px; color: var(--dim); text-decoration: none; border-radius: 8px; margin-bottom: 5px; cursor: pointer; transition: 0.3s; }
        .nav-link:hover, .nav-link.active { background: #1a1a20; color: var(--blue); box-shadow: inset 3px 0 0 var(--blue); }
        .main-content { margin-left: 260px; padding: 30px; min-height: 100vh; }

        /* Header Components */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header-right { display: flex; align-items: center; gap: 15px; }
        .coins-box { background: #000; padding: 10px 20px; border-radius: 30px; border: 1px solid var(--blue); color: var(--blue); font-weight: 700; display: flex; align-items: center; gap: 10px; box-shadow: var(--neon); }
        
        .notif-btn { position: relative; width: 45px; height: 45px; background: #111; border: 1px solid #222; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; color: var(--dim); }
        .notif-btn:hover { border-color: var(--blue); color: var(--blue); }
        .badge-dot { position: absolute; top: 0; right: 0; width: 12px; height: 12px; background: var(--red); border-radius: 50%; border: 2px solid var(--bg); display: none; }

        /* Notification Panel */
        #notif-panel { position: fixed; top: 0; right: -350px; width: 320px; height: 100vh; background: var(--card); z-index: 1001; border-left: 1px solid #222; transition: 0.4s; padding: 25px; box-shadow: -10px 0 30px rgba(0,0,0,0.5); }
        #notif-panel.active { right: 0; }
        .notif-item { background: #0a0a0c; border: 1px solid #222; padding: 12px; border-radius: 8px; margin-bottom: 10px; font-size: 0.85rem; border-left: 3px solid var(--blue); }
        .notif-item.unread { border-left-color: var(--red); background: #1a1111; }

        /* UI Cards */
        .section { display: none; animation: fadeIn 0.4s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .card { background: var(--card); border: 1px solid #222; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        
        .plan-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 20px 0; }
        .plan-card { background: #0a0a0c; border: 1px solid #333; padding: 15px; text-align: center; border-radius: 10px; cursor: pointer; font-weight: 700; transition: 0.2s; }
        .plan-card.selected { border-color: var(--blue); color: var(--blue); box-shadow: var(--neon); }
        
        /* QR Styling */
        .qr-container { background: #fff; padding: 12px; border-radius: 12px; margin: 0 auto 20px; width: fit-content; border: 4px solid var(--blue); }
        .qr-image { width: 200px; height: 200px; display: block; }

        input, select { width: 100%; padding: 12px; margin-bottom: 15px; background: #000; border: 1px solid #333; color: #fff; border-radius: 6px; }
        .btn { padding: 12px 20px; border-radius: 6px; border: none; cursor: pointer; font-family: 'Orbitron'; font-weight: bold; text-transform: uppercase; transition: 0.3s; display: inline-flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-primary { background: var(--blue); color: #000; }
        .btn-red { background: var(--red); color: #fff; }

        @media (max-width: 768px) {
            .sidebar { width: 100%; height: 70px; bottom: 0; top: auto; position: fixed; display: flex; padding: 5px; flex-direction: row; border-right: none; border-top: 1px solid #222; }
            .sidebar .logo, .sidebar .u-info { display: none; }
            .sidebar .nav-link { flex-direction: column; font-size: 0.6rem; padding: 5px; flex: 1; text-align: center; }
            .main-content { margin-left: 0; padding: 20px 20px 100px 20px; }
            #notif-panel { width: 100%; right: -100%; }
        }
    </style>
</head>
<body>

    <!-- Auth Layer -->
    <div id="auth-overlay">
        <div class="auth-box">
            <h2 style="text-align: center; color: var(--blue); margin-bottom: 20px;">GUILD ZONE</h2>
            <div class="auth-tabs">
                <button id="l-tab" class="active" onclick="setAuthMode('login')">Login</button>
                <button id="s-tab" onclick="setAuthMode('signup')">Register</button>
            </div>
            <form id="auth-form">
                <div id="signup-only" style="display: none;">
                    <input type="text" id="ign" placeholder="In-Game Name">
                    <select id="role"><option value="player">Player</option><option value="leader">Guild Leader</option></select>
                </div>
                <input type="email" id="email" placeholder="Email" required>
                <input type="password" id="password" placeholder="Password" required>
                <button type="submit" class="btn btn-primary" style="width: 100%;" id="auth-btn">Authorize</button>
            </form>
        </div>
    </div>

    <!-- App Shell -->
    <div id="app-shell">
        <aside class="sidebar">
            <div class="logo" style="color: var(--blue); text-align: center; margin-bottom: 30px;"><h3>G-ZONE</h3></div>
            <div class="u-info" style="margin-bottom: 20px; padding: 0 10px; border-bottom: 1px solid #222; padding-bottom: 15px;">
                <p id="nav-ign" style="font-weight: 700;"></p>
                <p id="nav-role" style="color: var(--blue); font-size: 0.7rem; text-transform: uppercase;"></p>
            </div>
            <div class="nav-link active" onclick="nav('dash')"><i class="fas fa-home"></i> Dashboard</div>
            <div class="nav-link" onclick="nav('tourneys')"><i class="fas fa-trophy"></i> Tournaments</div>
            <div class="nav-link" onclick="nav('guilds')"><i class="fas fa-users"></i> Guilds</div>
            <div class="nav-link" onclick="nav('topup')"><i class="fas fa-wallet"></i> Top-up</div>
            <div class="nav-link" onclick="firebase.auth().signOut()" style="color: var(--red); margin-top: auto;"><i class="fas fa-power-off"></i> Logout</div>
        </aside>

        <main class="main-content">
            <div class="header">
                <h2 id="page-title">Arena</h2>
                <div class="header-right">
                    <div class="notif-btn" onclick="openNotifPanel()">
                        <i class="fas fa-bell"></i>
                        <div id="notif-badge" class="badge-dot"></div>
                    </div>
                    <div class="coins-box"><i class="fas fa-coins"></i> <span id="coin-bal">0</span></div>
                </div>
            </div>

            <!-- Notifications Panel -->
            <div id="notif-panel">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3>Alerts</h3>
                    <i class="fas fa-times" style="cursor:pointer" onclick="closeNotifPanel()"></i>
                </div>
                <div id="notif-list"></div>
            </div>

            <!-- Main Sections -->
            <section id="sect-dash" class="section active">
                <!-- Guild Leader Management Card (Only visible if you own a guild) -->
                <div id="leader-panel" class="card" style="display:none; border-color: var(--blue);">
                    <h3 style="font-size: 1rem;">Guild Management: <span id="my-guild-name" style="color:#fff"></span></h3>
                    <div id="my-members" style="margin-top: 15px;"></div>
                </div>
                <h3 style="margin-bottom: 15px;">Live Tournaments</h3>
                <div id="dash-tourneys" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap:20px;"></div>
            </section>

            <section id="sect-tourneys" class="section"><div id="all-tourneys" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap:20px;"></div></section>
            
            <section id="sect-guilds" class="section">
                <!-- Create Guild Button (Only visible to Leaders who don't have a guild yet) -->
                <div id="leader-create-box" style="display:none; margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="toggleModal('g-modal', true)">+ Create New Guild</button>
                </div>
                <div id="all-guilds" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap:20px;"></div>
            </section>

            <section id="sect-topup" class="section">
                <div class="card" style="max-width: 550px; margin: 0 auto; text-align: center;">
                    <h3>Buy Coins</h3>
                    <div class="qr-container" style="margin-top:20px;">
                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=upi://pay?pa=ujjwalraj738@okhdfcbank&pn=ujjwal%20Raj&cu=INR" class="qr-image">
                    </div>
                    <div style="background:#000; border: 1px dashed var(--blue); padding:12px; text-align:center; border-radius:10px; margin-bottom:20px;">
                        <small>UPI: ujjwalraj738@okhdfcbank</small>
                    </div>
                    <div class="plan-grid">
                        <div class="plan-card" onclick="selectPlan(50, 150)">₹50 = 150 Coins</div>
                        <div class="plan-card" onclick="selectPlan(100, 300)">₹100 = 300 Coins</div>
                        <div class="plan-card" onclick="selectPlan(200, 700)">₹200 = 700 Coins</div>
                        <div class="plan-card" onclick="selectPlan(500, 2000)">₹500 = 2000 Coins</div>
                    </div>
                    <form id="topup-form" style="text-align: left;">
                        <input type="hidden" id="sel-amt">
                        <p id="plan-info" style="margin-bottom: 15px; color: var(--blue); font-weight: bold; text-align: center;"></p>
                        <input type="file" id="t-file" accept="image/*" required>
                        <button type="submit" class="btn btn-primary" style="width: 100%;" id="t-btn">Submit Proof</button>
                    </form>
                </div>
            </section>
        </main>
    </div>

    <!-- Create Guild Modal -->
    <div id="g-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:2000; align-items:center; justify-content:center;">
        <div class="auth-box">
            <h3>Start Your Guild</h3><br>
            <p style="color:var(--dim); font-size:0.8rem; margin-bottom:15px;">Warning: You can only own one guild.</p>
            <input type="text" id="g-name" placeholder="Guild Name">
            <button class="btn btn-primary" style="width:100%" onclick="handleCreateGuild()">Confirm Creation</button>
            <button class="btn btn-outline" style="width:100%; margin-top:10px;" onclick="toggleModal('g-modal', false)">Cancel</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAR5p2G_eZsVIR4C6a1eGatmGjERXguzVc",
            authDomain: "guild-zone-e3509.firebaseapp.com",
            projectId: "guild-zone-e3509",
            storageBucket: "guild-zone-e3509.firebasestorage.app",
            messagingSenderId: "205602044671",
            appId: "1:205602044671:web:e01f3e5f2cc10ddddbeaca",
            measurementId: "G-6PM8LZ7FJR"
        };
        const IMGBB_KEY = "b518d2881029e5c3b4ae1324a7bc0f02";
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let user = null;
        let mode = 'login';
        let hasGuild = false; // To track guild ownership

        function setAuthMode(m) {
            mode = m;
            document.getElementById('l-tab').className = m === 'login' ? 'active' : '';
            document.getElementById('s-tab').className = m === 'signup' ? 'active' : '';
            document.getElementById('signup-only').style.display = m === 'signup' ? 'block' : 'none';
        }

        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('auth-btn');
            btn.disabled = true; btn.innerText = "Processing...";
            try {
                if(mode === 'signup') {
                    const ign = document.getElementById('ign').value;
                    const role = document.getElementById('role').value;
                    if(!ign) throw new Error("IGN required");
                    const res = await auth.createUserWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value);
                    await db.collection('users').doc(res.user.uid).set({ uid: res.user.uid, email: res.user.uid, ign, role, coins: 0, createdAt: new Date() });
                } else { await auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value); }
            } catch (err) { alert(err.message); btn.disabled = false; btn.innerText = "Enter Arena"; }
        });

        auth.onAuthStateChanged(u => {
            if(u) {
                db.collection('users').doc(u.uid).onSnapshot(doc => {
                    if(doc.exists) {
                        user = doc.data();
                        document.getElementById('auth-overlay').style.display = 'none';
                        document.getElementById('app-shell').style.display = 'block';
                        renderUI();
                        loadData();
                        listenNotifs();
                    }
                });
            } else { document.getElementById('app-shell').style.display = 'none'; document.getElementById('auth-overlay').style.display = 'flex'; }
        });

        function renderUI() {
            document.getElementById('nav-ign').innerText = user.ign;
            document.getElementById('nav-role').innerText = user.role;
            document.getElementById('coin-bal').innerText = user.coins;
        }

        function toggleNotif(show) { document.getElementById('notif-panel').classList.toggle('active', show); }
        function openNotifPanel() { 
            toggleNotif(true); 
            db.collection('notifications').where('uid','==',user.uid).where('read','==',false).get().then(s => {
                const b = db.batch(); s.forEach(d => b.update(d.ref, {read:true})); b.commit();
            });
        }
        function closeNotifPanel() { toggleNotif(false); }

        function listenNotifs() {
            db.collection('notifications').where('uid','==',user.uid).orderBy('timestamp','desc').limit(15).onSnapshot(s => {
                const l = document.getElementById('notif-list');
                const b = document.getElementById('notif-badge');
                l.innerHTML = ''; let unread = 0;
                s.forEach(d => { const n = d.data(); if(!n.read) unread++; l.innerHTML += `<div class="notif-item ${n.read ? '' : 'unread'}">${n.message}</div>`; });
                b.style.display = unread > 0 ? 'block' : 'none';
            });
        }

        function nav(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById('sect-' + id).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        function selectPlan(rs, coins) {
            document.querySelectorAll('.plan-card').forEach(p => p.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            document.getElementById('sel-amt').value = rs;
            document.getElementById('plan-info').innerText = `Selected: ₹${rs} = ${coins} Coins`;
        }

        function loadData() {
            // Tournaments
            db.collection('tournaments').orderBy('createdAt', 'desc').onSnapshot(snap => {
                const d = document.getElementById('dash-tourneys');
                const a = document.getElementById('all-tourneys');
                d.innerHTML = ''; a.innerHTML = '';
                snap.forEach(doc => {
                    const t = doc.data();
                    const card = `<div class="card"><h3>${t.title}</h3><p>Entry: ${t.entryCoins} Coins</p><button class="btn btn-primary" style="width:100%; margin-top:10px;">Details</button></div>`;
                    a.innerHTML += card; if(d.children.length < 3) d.innerHTML += card;
                });
            });

            // Guild Ownership Check & Display
            db.collection('guilds').onSnapshot(snap => {
                const list = document.getElementById('all-guilds');
                const leadPanel = document.getElementById('leader-panel');
                const leadBtnBox = document.getElementById('leader-create-box');
                const memList = document.getElementById('my-members');
                list.innerHTML = '';
                hasGuild = false;

                snap.forEach(doc => {
                    const g = doc.data();
                    const isMine = g.leaderUid === user.uid;
                    if(isMine) {
                        hasGuild = true;
                        leadPanel.style.display = 'block';
                        document.getElementById('my-guild-name').innerText = g.name;
                        memList.innerHTML = '';
                        (g.members || [user.uid]).forEach(m => {
                            memList.innerHTML += `<div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #222;"><span>UID: ${m.substring(0,8)}...</span> ${m !== user.uid ? `<button class="btn btn-red" style="padding:4px 10px; font-size:0.7rem;" onclick="kick('${doc.id}','${m}')">Kick</button>` : '<b style="color:var(--blue)">Leader</b>'}</div>`;
                        });
                    }
                    list.innerHTML += `<div class="card"><h3>${g.name}</h3><p>Leader: ${g.leaderIgn}</p><div style="display:flex; gap:10px; margin-top:10px;"><button class="btn btn-outline" style="flex:1">Join</button>${user.role === 'leader' && !isMine ? `<button class="btn btn-red" onclick="challenge('${doc.id}','${g.name}')">War</button>` : ''}</div></div>`;
                });

                // Guild Limit: Only show "Create Guild" if Leader AND doesn't have a guild
                if(user.role === 'leader' && !hasGuild) leadBtnBox.style.display = 'block';
                else leadBtnBox.style.display = 'none';
            });
        }

        document.getElementById('topup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const amt = document.getElementById('sel-amt').value;
            const btn = document.getElementById('t-btn');
            if(!amt) return alert("Select plan!");
            btn.disabled = true; btn.innerText = "Processing...";
            try {
                const formData = new FormData();
                formData.append('image', document.getElementById('t-file').files[0]);
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: 'POST', body: formData });
                const json = await res.json();
                if(!json.success) throw new Error("Upload Failed");
                await db.collection('topup_requests').add({ uid: user.uid, email: user.email, ign: user.ign, amount: Number(amt), proofImageURL: json.data.url, status: 'pending', createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                alert("Payment Proof Sent!"); e.target.reset();
            } catch (err) { alert(err.message); } finally { btn.disabled = false; btn.innerText = "Submit Proof"; }
        });

        async function handleCreateGuild() {
            const n = document.getElementById('g-name').value;
            if(!n) return;
            // Final logic check: Prevent double creation even if modal is open
            if(hasGuild) return alert("You already own a guild!");

            await db.collection('guilds').add({ name: n, leaderUid: user.uid, leaderIgn: user.ign, members: [user.uid], createdAt: firebase.firestore.FieldValue.serverTimestamp() });
            toggleModal('g-modal', false);
            alert("Guild Created Successfully!");
        }

        async function kick(gid, muid) {
            if(confirm("Kick?")) await db.collection('guilds').doc(gid).update({ members: firebase.firestore.FieldValue.arrayRemove(muid) });
        }

        async function challenge(id, name) {
            if(user.coins < 50) return alert("Need 50 coins!");
            await db.runTransaction(async (t) => {
                const s = await t.get(db.collection('users').doc(user.uid));
                t.update(db.collection('users').doc(user.uid), { coins: s.data().coins - 50 });
                t.add(db.collection('challenges'), { from: user.uid, fromIgn: user.ign, target: id, targetName: name, status: 'pending', createdAt: new Date() });
            });
            alert("War Declared!");
        }

        async function joinT(tid, fee) {
            if(user.coins < fee) return alert("Insufficient Balance!");
            await db.runTransaction(async (t) => {
                const s = await t.get(db.collection('users').doc(user.uid));
                t.update(db.collection('users').doc(user.uid), { coins: s.data().coins - fee });
            });
            alert("Joined!");
        }

        function toggleModal(id, s) { document.getElementById(id).style.display = s ? 'flex' : 'none'; }
    </script>
</body>
</html>